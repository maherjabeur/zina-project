{% extends 'base.html.twig' %}

{% block title %}Gestion des Commandes - Admin
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div
			class="row">
			<!-- Sidebar -->
			<nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
				<div class="position-sticky pt-3">
					<ul class="nav flex-column">
						<li class="nav-item">
							<a class="nav-link" href="{{ path('admin_dashboard') }}">
								<i class="fas fa-tachometer-alt"></i>
								Dashboard
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link " href="{{ path('admin_products') }}">
								<i class="fas fa-tshirt"></i>
								Produits
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link " href="{{ path('admin_sizes') }}">
								<i class="fas fa-ruler"></i>
								Tailles
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link " href="{{ path('admin_categories') }}">
								<i class="fas fa-tags"></i>
								Catégories
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link active" href="{{ path('admin_orders') }}">
								<i class="fas fa-shopping-cart"></i>
								Commandes
								{% set pending_orders = count_pending_orders() %}
								{% if pending_orders > 0 %}
									<span class="badge bg-danger">{{ pending_orders }}</span>
								{% endif %}
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="{{ path('admin_slider') }}">
								<i class="fas fa-images"></i>
								Slider
							</a>
						</li>
						  <li class="nav-item">
                        <a class="nav-link " href="{{ path('admin_settings') }}">
                            <i class="fas fa-dollar-sign"></i> Frais livraison
                        </a>
                    </li>
					<li class="nav-item">
							<a class="nav-link" href="{{ path('admin_promotion_index') }}">
								<i class="fas fa-gift"></i>
								Promotions
							</a>
						</li>

					</ul>
				</div>
			</nav>

			<!-- Main content -->
			<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
				<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
					<h1 class="h2">Gestion des Commandes</h1>
				</div>

				<!-- Barre de recherche et filtres -->
				<div class="row mb-4">
					<div class="col-md-6">
						<form method="GET" action="{{ path('admin_orders') }}">
							<div class="input-group">
								<input type="text" class="form-control" name="search" value="{{ search }}" placeholder="Rechercher une commande...">
								<button class="btn btn-outline-primary" type="submit">
									<i class="fas fa-search"></i>
								</button>
								{% if search %}
									<a href="{{ path('admin_orders') }}" class="btn btn-outline-secondary">
										<i class="fas fa-times"></i>
									</a>
								{% endif %}
							</div>
						</form>
					</div>
					<div class="col-md-6 text-md-end">
						<div class="btn-group">
							<button class="btn btn-outline-primary btn-sm" disabled>
								Total:
								{{ orders.getTotalItemCount }}
								commande(s)
							</button>
							<button class="btn btn-outline-secondary btn-sm" disabled>
								Page
								{{ orders.getCurrentPageNumber }}/{{ orders.getPageCount }}
							</button>
						</div>
					</div>
				</div>

				<!-- Filtres par statut -->
				<div class="row mb-4">
					<div class="col-12">
						<div class="btn-group" role="group">
							<a href="{{ path('admin_orders') }}" class="btn btn-outline-primary {{ not current_status ? 'active' : '' }}">
								Toutes ({{ orders.getTotalItemCount }})
							</a>
							{% for statusValue, statusLabel in constant('App\\Entity\\Order::STATUSES') %}
								<a href="{{ path('admin_orders', {'status': statusValue}) }}" class="btn btn-outline-primary {{ current_status == statusValue ? 'active' : '' }}">
									{{ statusLabel }}
								</a>
							{% endfor %}
						</div>
					</div>
				</div>

				<!-- Liste des commandes -->
				<div class="card">
					<div class="card-body">
						{% if orders|length > 0 %}
							<div class="table-responsive">
								<table class="table table-striped table-hover">
									<thead>
										<tr>
											<th>N° Commande</th>
											<th>Client</th>
											<th>Téléphone</th>
											<th>Email</th>
											<th>Total</th>
											<th>Statut</th>
											<th>Date</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for order in orders %}
											<tr>
												<td>
													<strong>{{ order.orderNumber }}</strong>
													{% if not order.notified %}
														<span class="badge bg-warning" title="Non notifié">N</span>
													{% endif %}
												</td>
												<td>{{ order.customerName }}</td>
												<td>{{ order.customerPhone }}</td>
												<td>{{ order.customerEmail }}</td>
												<td>{{ order.total }}
													Dt</td>
												<td>
													<form method="POST" action="{{ path('admin_order_update_status', {'id': order.id}) }}" class="d-inline">
														<select name="status" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto;">
															{% for statusValue, statusLabel in constant('App\\Entity\\Order::STATUSES') %}
																<option value="{{ statusValue }}" {{ order.status == statusValue ? 'selected' : '' }}>
																	{{ statusLabel }}
																</option>
															{% endfor %}
														</select>
													</form>
												</td>
												<td>{{ order.createdAt|date('d/m/Y H:i') }}</td>
												<td>
													<div class="btn-group btn-group-sm">
														<a href="{{ path('admin_order_show', {'id': order.id}) }}" class="btn btn-outline-primary" title="Voir détails">
															<i class="fas fa-eye"></i>
														</a>
														<form method="POST" action="{{ path('admin_order_delete', {'id': order.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette commande ?')" class="d-inline">
															<button type="submit" class="btn btn-outline-danger" title="Supprimer">
																<i class="fas fa-trash"></i>
															</button>
														</form>
													</div>
												</td>
											</tr>
										{% else %}
											<tr>
												<td colspan="7" class="text-center text-muted py-4">
													<i class="fas fa-shopping-cart fa-2x mb-3"></i><br>
													Aucune commande pour le moment
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>

							<!-- Pagination -->
							<div class="d-flex justify-content-between align-items-center mt-4">
								<div>
									<small class="text-muted">
										Affichage de
										{{ orders.getCurrentPageNumber * orders.getItemNumberPerPage - orders.getItemNumberPerPage + 1 }}
										à
										{{ min(orders.getCurrentPageNumber * orders.getItemNumberPerPage, orders.getTotalItemCount) }}
										sur
										{{ orders.getTotalItemCount }}
										commande(s)
									</small>
								</div>
								<div>
									{{ knp_pagination_render(orders, '@KnpPaginator/Pagination/twitter_bootstrap_v4_pagination.html.twig', {'translation_domain': 'messages'}) }}
								</div>
							</div>
						{% else %}
							<div class="text-center py-5">
								<i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
								<h3>
									{% if search or current_status %}
										Aucune commande trouvée
									{% else %}
										Aucune commande
									{% endif %}
								</h3>
								<p class="text-muted">
									{% if search %}
										Aucune commande ne correspond à votre recherche.
									{% elseif current_status %}
										Aucune commande avec le statut "{{ constant('App\\Entity\\Order::STATUSES')[current_status] }}".
									{% else %}
										Aucune commande n'a été passée pour le moment.
									{% endif %}
								</p>
								{% if search or current_status %}
									<a href="{{ path('admin_orders') }}" class="btn btn-primary">
										<i class="fas fa-list me-2"></i>
										Voir toutes les commandes
									</a>
								{% endif %}
							</div>
						{% endif %}
					</div>
				</div>
			</main>
		</div>
	</div>
{% endblock %}
